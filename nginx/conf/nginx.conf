
#user  nobody;
worker_processes  1;

#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;
worker_rlimit_nofile 65535;

events {
    use epoll;
    worker_connections  1024;
}


http {
    include       mime.types;
    default_type  application/octet-stream;
	proxy_set_header  Host $host;
	proxy_set_header  X-Real-IP $remote_addr;
	proxy_set_header  X-Forwarded-For $proxy_add_x_forwarded_for;
    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                      '$status $body_bytes_sent "$http_referer" '
                      '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;

    sendfile        on;
    #tcp_nopush     on;

    #keepalive_timeout  0;
    keepalive_timeout  65;

    #gzip  on;
    gzip  on;
    gzip_min_length 1k;
    gzip_buffers 16 64k;
    gzip_http_version 1.1;
    gzip_comp_level 9;
    gzip_proxied any;
    gzip_types text/plain application/x-javascript text/css application/xml;
    gzip_vary on;
    fastcgi_read_timeout 60s;

#    header_filter_by_lua '
#	ngx.header["Server"]="JBossWeb"
#	ngx.header["X-Powered-By"]="Servlet/2.5 JSP/2.1"        
#	';

    server {
 	listen       80;
        server_name  106.185.24.245;
	access_log  logs/newgenlites.access.log  main;
        server_name_in_redirect off;
	default_type text/html;
        root /usr/local/openresty/nginx/html/www.newgenlites.com;
	rewrite_by_lua '
			if string.find(ngx.var.uri,".asp")~=nil then
				if ngx.var.args~=nil then
					ngx.req.set_uri(ngx.var.uri.."?"..ngx.var.args)
	
				else
					ngx.req.set_uri(ngx.var.uri)	
				end
			end
	';
#	 rewrite_by_lua 'ngx.req.set_uri(ngx.var.uri.."%3f"..string.gsub(ngx.var.args.."","&","%%26"))';
#	access_by_lua 'ngx.say(string.gsub(ngx.var.args,"&","%%26"))';
	}

    server {
        listen       80;
        server_name  www.codezhai.com;
#	header_filter_by_lua '
#        ngx.header["Server"]="Segflow"
#        ngx.header["X-Powered-By"]="Segflow/Golang1.4"
#        ';
	
#        if ($http_user_agent ~* "python") {
#                return 403;
#        }
#        if ($http_user_agent ~* "urllib") {
#                return 403;
#        }
#        if ($http_user_agent ~* "LSSRocketCrawler") {
#                return 403;
#        }
#        if ($http_user_agent ~* "ia_archiver") {
#                return 403;
#        }
#        if ($http_user_agent ~* "java") {
#                return 403;
#        }
#        if ($http_user_agent ~* "YisouSpider") {
#                return 403;
#        }
#        if ($http_user_agent ~* "EasouSpider") {
#                return 403;
#        }
#	if ($http_user_agent ~* "nutch") {
#                return 403;
#        }

        #charset koi8-r;

        access_log  logs/codezhai.access.log  main;
	server_name_in_redirect off;
	root /usr/local/openresty/nginx/html/codezhai;

#	if (-f $request_filename/index.html){rewrite (.) $1/index.html break;}
#	if (-f $request_filename/index.php){rewrite (.) $1/index.php;}
#	if (!-f $request_filename){rewrite (.) /index.php;}
#	rewrite /wp-admin$ $scheme://$host$uri/ permanent;
	
	


	index index.php index.html;

   	location ~ \.php$ {



#		autoindex off;

		set $wp_super_cache_file '';
		set $wp_super_cache_uri $request_uri;
		if ( $request_method = POST )
		{
			set $wp_super_cache_uri '';
		}
		if ( $query_string )
		{
			set $wp_super_cache_uri '';
		}
		if ( $http_cookie ~* "comment_author_|WordPress|wp-postpass_" )
		{
			set $wp_super_cache_uri '';
		}
		if ( $wp_super_cache_uri ~ ^(.+)$ )
		{
			set $wp_super_cache_file /wp-content/cache/wp_super_cache/$http_host/$1index.html;
		}
		if ( -f $document_root$wp_super_cache_file )
		{
			rewrite ^(.*)$ $wp_super_cache_file break;
		}
		if (-f $request_filename)
		{
			expires 30d;
			break;
		}
		if (!-e $request_filename)
		{
			rewrite ^(.+)$ /index.php?q=$1 last;

		}




        	fastcgi_pass 127.0.0.1:9000;
        	fastcgi_index index.php;
        	fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
        	include fastcgi_params;
        }
 
        location ~* ^.+\.(mp3|mp4|ttf|rss|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ {
	access_log off;
        log_not_found off;
        expires 1d;
		}
 
        location / {
        	try_files $uri $uri/ /index.php?q=$uri&$args;
	}

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html/err;
        }

    }




 server {
        listen       80;
        server_name  www.acgzhai.net acgzhai.net;
	gzip  off;
    	header_filter_by_lua '
       	ngx.header["Server"]="Segflow"
       	ngx.header["X-Powered-By"]="Segflow/Golang1.4"
       	';


        charset utf-8;

        access_log  logs/acgzhai.access.log  main;
	server_name_in_redirect off;
	root /usr/local/openresty/nginx/html/acgzhai;

	index index.html index.php;

   location ~ \.php$ {

        fastcgi_pass 127.0.0.1:9000;
        fastcgi_index index.php;
        fastcgi_param  SCRIPT_FILENAME $document_root$fastcgi_script_name;
        include fastcgi_params;
        }
 
        location ~* ^.+\.(mp3|mp4|ttf|rss|jpg|jpeg|gif|png|ico|zip|tgz|gz|rar|bz2|doc|xls|exe|ppt|tar|mid|midi|wav|bmp|rtf)$ {
	access_log off;
        log_not_found off;
        expires 1d;
		}
 
        location / {
 #       	try_files $uri $uri/ /index.php?q=$uri&$args;
	}
	location /search/{
		proxy_pass http://106.185.24.245:8983/solr/collection1/;
		#proxy_redirect default ;
		proxy_redirect off; 
	}
	location /select{
		charset utf-8;
		default_type text/html;
		content_by_lua_file "lua/select.lua";
	}

        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html/err;
        }


	location /acfun{
		 gzip  off;
		 lua_code_cache off;
		ssi off;  
                charset utf-8;
                default_type text/html;
                content_by_lua_file "lua/del.lua";
	}
}

    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

}
